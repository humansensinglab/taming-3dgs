name: Build Model Gen Job Docker Image

on:
  push:
    branches: [ "main" ]

env:
  AWS_REGION: us-east-1
  ECR_REPOSITORY: frolic-ai/model-gen-job
  IMAGE_TAG: ${{ github.sha }}

permissions:
  contents: read

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    environment: development

    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID_V2 }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY_V2 }}
        aws-region: ${{ env.AWS_REGION }}

    - name: Login to Amazon ECR
      id: login-ecr
      uses: aws-actions/amazon-ecr-login@v2

    - name: Download config from S3
      run: |
        mkdir -p configs
        aws s3 cp s3://future-gadgets-service-confs/backend/model-gen-job/.aws aws

    - name: Build and push image to ECR
      uses: docker/build-push-action@v5
      with:
        context: .
        push: true
        tags: ${{ env.ECR_REGISTRY }}/${{ env.ECR_REPOSITORY }}:${{ env.IMAGE_TAG }}
        platforms: linux/amd64

    - name: Notify Feishu
      if: always()
      run: |
        STATUS="${{ job.status }}"
        COLOR=$([ "$STATUS" == "success" ] && echo "green" || echo "red")
        ICON=$([ "$STATUS" == "success" ] && echo "ğŸš€" || echo "âš ï¸")
        STATUS_TEXT=$([ "$STATUS" == "success" ] && echo "æˆåŠŸ" || echo "å¤±è´¥")
        
        # è½¬ä¹‰æäº¤ä¿¡æ¯ä¸­çš„ç‰¹æ®Šå­—ç¬¦
        COMMIT_MESSAGE=$(echo "${{ github.event.head_commit.message }}" | sed 's/"/\\"/g' | tr '\n' ' ')
        
        curl -X POST -H "Content-Type: application/json" \
        -d "{
          \"msg_type\": \"interactive\",
          \"card\": {
            \"header\": {
              \"title\": {
                \"tag\": \"plain_text\",
                \"content\": \"${ICON} Build Model Gen Job Docker Image ${STATUS_TEXT}\"
              },
              \"template\": \"${COLOR}\"
            },
            \"elements\": [
              {
                \"tag\": \"div\",
                \"text\": {
                  \"tag\": \"lark_md\",
                  \"content\": \"$([ "$STATUS" == "success" ] && echo "âœ…" || echo "âŒ") **BuildçŠ¶æ€**ï¼š${STATUS_TEXT}\\nğŸŒ **ç¯å¢ƒ**ï¼šæµ‹è¯•ç¯å¢ƒ\\nğŸ“¦ **ä»“åº“**ï¼š[${{ github.repository }}](${{ github.server_url }}/${{ github.repository }})\\nğŸ”€ **åˆ†æ”¯**ï¼š${{ github.ref_name }}\\nğŸ“ **æäº¤**ï¼š[${{ github.sha }}](${{ github.server_url }}/${{ github.repository }}/commit/${{ github.sha }})\\nğŸ‘¤ **è§¦å‘è€…**ï¼š${{ github.actor }}\\n\\nğŸ“ **æäº¤ä¿¡æ¯**ï¼š${COMMIT_MESSAGE}\"
                }
              }
            ]
          }
        }" ${{ secrets.FEISHU_WEBHOOK_URL }}